#!/bin/bash

# ATTENTION: we use btorold2new filter as workaround

btorgen=unknown
for d in `echo $PATH | sed -e 's,:, ,g'` .
do
  file=$d/btorgen
  [ -d $d ] || continue
  [ -f $file ] || continue
  btorgen=$file
  break
done
if [ $btorgen = unknown ]; then
  echo "*** testbtorbtorgen: can not find 'btorgen'" 1>&2
  exit 1
fi

i=0
file="/tmp/testbtorbtorgen$$.btor"
refinementlimit=100000

while true 
do 
  ((i++))
  rwl=rwl2
  echo -n "Test $i $rwl: "
  btorgen 2> /dev/null | btorold2new > $file 
  if [ ! -s $file ]; then
    echo "*** testbtorbtorgen: generated file is empty"
    exit 1
  fi 
  boolector -$rwl -rl $refinementlimit $file
  goldenretval=$?
  if [[ $goldenretval -ne 2 ]] && [[ $goldenretval -ne 3 ]]; then
    echo "ERROR"
    cp $file ./error.btor
    rm -f $file
    exit
  fi
  for rwl in rwl1 rwl0
  do
    echo -n "Test $i $rwl: "
    boolector -$rwl -rl $refinementlimit $file 
    retval=$?
    if [[ $retval -ne $goldenretval ]]; then
      echo "ERROR"
      cp $file ./error.btor
      rm -f $file
      exit
    fi 
  done
  echo ""
done
