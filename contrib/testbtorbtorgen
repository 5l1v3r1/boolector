#!/bin/bash

# ATTENTION: we use btorold2new filter as workaround for btorgen

usage="*** testbtorbtorgen: usage: ./testbtorbtorgen [id] [-cov]" 
covdir="./covtests/"

btorgen=unknown
for d in `echo $PATH | sed -e 's,:, ,g'` .
do
  file=$d/btorgen
  [ -d $d ] || continue
  [ -f $file ] || continue
  btorgen=$file
  break
done
if [[ $btorgen = unknown ]]; then
  echo "*** testbtorbtorgen: can not find 'btorgen'" 1>&2
  exit 1
fi

btorgenjava=unknown
for d in `echo $PATH | sed -e 's,:, ,g'` .
do
  file=$d/btorgenjava
  [ -d $d ] || continue
  [ -f $file ] || continue
  btorgenjava=$file
  break
done
if [[ $btorgenjava = unknown ]]; then
  echo "*** testbtorbtorgen: can not find 'btorgenjava'" 1>&2
  exit 1
fi

i=0
counter=0
valgrindcheck=100 # every nth testcase we perform a memory check with valgrind
file="/tmp/testbtorbtorgen$$.btor"
filedump="/tmp/testbtorbtorgendump$$.btor"
fileoutputmodel="/tmp/testbtorbtorgenoutputmodel$$.btor"
refinementlimit=100000
last=btorgenjava
cov=no
id=1

if [[ $# -gt 2 ]]; then
  echo $usage 1>&2
  exit 1
fi

#parse arguments
if [[ $# -eq 2 ]]; then
  if [[ $1 = "-cov" ]]; then
    cov=yes
    id=$2
  elif [[ $2 = "-cov" ]]; then
    cov=yes
    id=$1
  else
    echo $usage 1>&2
    exit 1
  fi
elif [[ $# -eq 1 ]]; then
  if [[ $1 = "-cov" ]]; then
    cov=yes
  else
    id=$1
  fi
fi

fileerror="error"$id".btor"

if [[ $cov = yes ]]; then
  rm -r -f $covdir
  mkdir $covdir
  if [[ ! -e $covdir ]] || [[ ! -d $covdir ]] || \
     [[ ! -r $covdir ]] || [[ ! -w $covdir ]]; then
    echo "IO error"
    exit 1
  fi
fi

while true 
do 
  ((i++))
  ((counter++))
  rwl=rwl3

  randomnumber=$RANDOM
  ((randomnumber %= 2))
  if [[ $randomnumber -eq 0 ]]; then
    uamode=uag
  else
    uamode=ual
  fi

  randomnumber=$RANDOM
  ((randomnumber %= 2))
  if [[ $randomnumber -eq 0 ]]; then
    uabwref=uad
  else
    uabwref=uai
  fi

  randomnumber=$RANDOM
  ((randomnumber %= 3))
  if [[ $randomnumber -eq 0 ]]; then
    uaenc=uaz
  elif [[ $randomnumber -eq 1 ]]; then
    uaenc=uao
  else
    uaenc=uas
  fi

  uarwl=$RANDOM
  ((uarwl %= 4))

  checkmodel=$RANDOM
  ((checkmodel %= 2))

  if [ $last = btorgen ]; then
    btorgenjava 2> /dev/null | sed -e 's,nego,redxor,g' | btorold2new > $file 
    last=btorgenjava
  else
    btorgen 2> /dev/null | btorold2new > $file 
    last=btorgen
  fi

  if [ ! -s $file ]; then
    echo "*** testbtorbtorgen: generated file is empty"
    exit 1
  fi 

  echo -n "Test $i $rwl: "

  if [[ $cov = yes ]]; then
    covfile=$covdir"cov_id"$id"_test"$i"_"$rwl
  fi
  callstring="-$rwl -rl $refinementlimit $file"
  if [[ $uarwl -eq 3 ]]; then
    callstring=$callstring" -$uamode -$uabwref -$uaenc"
  fi

  if [[ $checkmodel -eq 1 ]]; then
    callstring=$callstring" -m"
    if [[ $cov = yes ]]; then
      boolector $callstring 1> $fileoutputmodel 2> $covfile".err"
      goldenretval=$?
      echo ${callstring/" $file"/""} > $covfile".cs"
    else
      boolector $callstring > $fileoutputmodel
      goldenretval=$?
    fi
    head -n 1 $fileoutputmodel
  else
    if [[ $cov = yes ]]; then
      boolector $callstring 2> $covfile".err"
      goldenretval=$?
      echo ${callstring/" $file"/""} > $covfile".cs"
    else
      boolector $callstring
      goldenretval=$?
    fi
  fi

  if [[ $goldenretval -ne 2 ]] && [[ $goldenretval -ne 3 ]]; then
    echo "ERROR"
    cp $file $fileerror
    echo "; error: $callstring" >> $fileerror
    exit
  fi

  if [[ $checkmodel -eq 1 ]] && [[ $goldenretval -eq 2 ]]; then
    btorcheckmodel $file $fileoutputmodel 
    retval=$?
    if [[ $retval -ne 0 ]]; then
      echo "ERROR"
      cp $file $fileerror
      cp $fileoutputmodel $fileerror".model"
      echo "; error: $callstring" >> $fileerror
      exit 1
    fi
  fi

  for rwl in 2 1 0
  do
    echo -n "Test $i rwl$rwl: "

    if [[ $cov = yes ]]; then
      covfile=$covdir"cov_id"$id"_test"$i"_rwl"$rwl
    fi
    callstring="-rwl$rwl -rl $refinementlimit $file"
    if [[ $uarwl -eq $rwl ]]; then
      callstring=$callstring" -$uamode -$uabwref -$uaenc"
    fi

    if [[ $checkmodel -eq 1 ]]; then
      callstring=$callstring" -m"
      if [[ $cov = yes ]]; then
	boolector $callstring 1> $fileoutputmodel 2> $covfile".err"
	retval=$?
	echo ${callstring/" $file"/""} > $covfile".cs"
      else
	boolector $callstring > $fileoutputmodel
	retval=$?
      fi
      head -n 1 $fileoutputmodel
    else
      if [[ $cov = yes ]]; then
	boolector $callstring 2> $covfile".err"
	retval=$?
	echo ${callstring/" $file"/""} > $covfile".cs"
      else
	boolector $callstring
	retval=$?
      fi
    fi

    if [[ $retval -ne $goldenretval ]]; then
      echo "ERROR"
      cp $file $fileerror
      echo "; error: $callstring" >> $fileerror
      exit 1
    fi 
  done

  echo -n "Test $i dump: "
  boolector $file -de 1> $filedump 2> /dev/null
  boolector -rl $refinementlimit $filedump 2> /dev/null
  retval=$?
  if [[ $retval -ne $goldenretval ]]; then
    echo "ERROR"
    cp $file $fileerror
    echo "; dump error" >> $fileerror
    exit 1
  fi 

  if [[ $checkmodel -eq 1 ]] && [[ $retval -eq 2 ]]; then
    btorcheckmodel $file $fileoutputmodel 
    retval=$?
    if [[ $retval -ne 0 ]]; then
      echo "ERROR"
      cp $file $fileerror
      cp $fileoutputmodel $fileerror".model"
      echo "; error: $callstring" >> $fileerror
      exit 1
    fi
  fi

  if [[ $counter -eq $valgrindcheck ]]; then
    counter=0
    echo -n "Test $i valg: "
    memerr=`valgrind -q ../boolector $file 2>&1 | grep ==`
    if [[ -n $memerr ]]; then
      echo ""
      echo "ERROR"
      cp $file $fileerror
      echo "; valgrind error" >> $fileerror
      exit 1
    fi 
    echo "OK"
  fi

  echo ""
done
