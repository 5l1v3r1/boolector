#!/bin/bash

if [[ $# -ne 2 ]]; then
  echo "Usage: ./instrumentsourcecov <source-file> <start-id>"
  exit 1;
fi

counter=0
declare -a unreached
file=$1

if [[ ! -e $file".gcov" || ! -r $file".gcov" ]]; then
  echo "Could not read ${file}.gcov"
  exit 1
fi

id=$2

while read line
do
  if [[ "${line:0:6}" = "#####:" ]]; then
    substr=${line:7}
    pos=`expr index "$substr" ":"`
    ((pos--))
    unreached[$counter]=${substr:0:pos}
    ((counter++))
  fi
done < "${file}.gcov"

len=$counter
counter=1
i=0
lastline=""
output=${file}.ins
rm -f $output

echo "#include <stdio.h>" >> "$output"

while read -r line
do
  if [[ "${unreached[$i]}" -eq "$counter" ]]; then

    if [[ `expr match "$line" "{"` -ne 1 ]] && \
       [[ `expr match "$line" "}"` -ne 1 ]] && \
       [[ `expr match "$line" "if"` -ne 2 ]] && \
       [[ `expr match "$line" "else"` -ne 4 ]] && \
       [[ `expr match "$line" "while"` -ne 5 ]] && \
       [[ `expr match "$line" "do"` -ne 2 ]] && \
       [[ `expr match "$line" "for"` -ne 3 ]] && \
       [[ `expr match "$line" "switch"` -ne 6 ]] && \
       [[ `expr "$line" : '.*\(:\)'` != ":" ]]; then

      if [[ `expr match "$lastline" "if"` -eq 2 ]] || \
	 [[ `expr match "$lastline" "else"` -eq 4 ]] || \
	 [[ `expr match "$lastline" "while"` -eq 5 ]] || \
	 [[ `expr match "$lastline" "do"` -eq 2 ]] || \
	 [[ `expr match "$lastline" "switch"` -eq 6 ]] || \
	 [[ `expr match "$lastline" "for"` -eq 3 ]]; then
	 echo -n "{ fprintf(stderr, \"%d\\n\", $id); " >> "$output"
	 echo "$line }" >> "$output"
      else
	echo "fprintf(stderr, \"%d\\n\", $id);" >> "$output"
	echo "$line" >> "$output"
      fi
     ((id++))

    else
      echo "$line" >> "$output"
    fi	

    if [[ "$i" -lt "$len" ]]; then
      ((i++))
    fi
  else
    echo "$line" >> "$output"
  fi
  ((counter++))
  lastline=$line
done < "$file"

echo "$id"
exit 0
