.SUFFIXES: .o .c .cc

MAKEFLAGS=-j $(if $(CORES),$(CORES),1)
CC=@CC@
CXX=@CXX@
BINDIR=@BINDIR@
BUILDIR=@BUILDIR@
TESTDIR=@TESTDIR@
SRCDIR=@SRCDIR@
SRCDIRS=@SRCDIRS@
INCS=@INCS@
CFLAGS=@CFLAGS@
OBJS=@OBJS@
LIBS=@LIBS@
LDEPS=@LDEPS@
VERSION=$(shell cat VERSION)
LIBOBJS=$(filter-out $(BUILDIR)/btormain.o $(BUILDIR)/btormbt.o $(BUILDIR)/btoruntrace.o, $(subst $(SRCDIR), $(BUILDIR), $(patsubst %.c,%.o,$(foreach d,$(SRCDIRS),$(wildcard $(d)/btor[a-z]*.c)))))
LIBOBJS+=$(BUILDIR)/boolector.o $(BUILDIR)/utils/boolectormap.o $(OBJS)
SRCS=$(foreach d,$(SRCDIRS),$(wildcard $(d)/*.[c|h|cc]))
TARGETS=@TARGETS@
ROOT=$(shell pwd|sed -e 's, ,\\ ,g')

all: $(BUILDIR)/libboolector.a $(TARGETS)

-include $(BUILDIR)/dependencies
-include test.mk
-include ibv.mk
-include mbt.mk
-include python.mk

$(BUILDIR)/%.o: $(SRCDIR)/%.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -c $< -o $@

$(BUILDIR)/%.o: $(SRCDIR)/%.cc
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -c $< -o $@

$(BUILDIR)/btorconfig.h: makefile VERSION mkconfig
	@mkdir -p $(@D)
	rm -f $@; ./mkconfig > $@

$(BUILDIR)/dependencies: $(BUILDIR)/btorconfig.h $(SRCS) makefile
	@mkdir -p $(@D)
	rm -f $@
	for srcdir in $(SRCDIRS); \
	do \
	  find $$srcdir/ -maxdepth 1 -name "*.[ch]" -o -name \*.cc | \
	  xargs $(CC) $(CFLAGS) $(INCS) -MM | \
	  sed -e 's,\(.*\):,'$(BUILDIR)/$$srcdir/'\1: makefile,' | \
		sed -e 's,$(SRCDIR)/\(.*\.o\),\1,' >>$@; \
	done

$(BUILDIR)/analyze:
	@mkdir -p $(@D)
	clang --analyze $(CFLAGS) $(INCS) \
	  $(shell find $(SRCDIRS) -maxdepth 1 -name "*.[ch]" -o -name "*.cc")

$(BUILDIR)/libboolector.a: $(LIBOBJS)
	@mkdir -p $(@D)
	rm -f $@
	ar rc $@ $(LIBOBJS)
	ranlib $@

SONAME=-Xlinker -soname -Xlinker $(BUILDIR)/libboolector.so
SHOBJS=$(filter-out $(BUILDIR)/btormbt.o $(BUILDIR)/btoruntrace.o $(BUILDIR)/btormain.o $(BUILDIR)/boolectormain.o, $(LIBOBJS))
$(BUILDIR)/libboolector.so: $(SHOBJS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -shared -o $@ $(SHOBJS) $(LIBS) $(SONAME)

$(BINDIR)/boolector: $(BUILDIR)/btormain.o $(BUILDIR)/boolectormain.o $(BUILDIR)/libboolector.a $(LDEPS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -o $@ $(BUILDIR)/btormain.o $(BUILDIR)/boolectormain.o -L$(BUILDIR) -lboolector $(LIBS) $(LDEPS)

clean:
	rm -f $(TARGETS)
	rm -f makefile
	rm -f $(foreach d,$(SRCDIRS),$(d)/*.{gcda,gcno,gcov,plist})
	rm -f log/*.log *.tmp
	rm -f *.a *.so $(foreach d,$(SRCDIRS),$(d)/*.o)# TODO remove
	rm -f -r $(BINDIR)
	rm -f -r $(BUILDIR)


.PHONY: all analyze clean
