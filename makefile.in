.SUFFIXES: .o .c
.c.o:
	$(CC) $(CFLAGS) -c $<
SHELL=/bin/sh
VERSION=$(shell cat VERSION)
PICOSATOBJ=../picosat/picosat.o ../picosat/version.o @PICOPREP_OBJS@ 
LIBOBJ= \
  $(addsuffix .o,$(basename $(wildcard btor*.c))) \
  boolector.o $(PICOSATOBJ)
TESTOBJ=$(addsuffix .o,$(basename $(wildcard test*.c)))
CC=@CC@
CFLAGS=@CFLAGS@
LIBS=@LIBS@
SRC=$(shell ls *.c *.h|grep -v merged)

all: libboolector.a boolector test synthebtor deltabtor basicbtor

-include dependencies

dependencies: btorconfig.h $(SRC) makefile
	rm -f $@; $(CC) $(CFLAGS) -MM *.c|sed -e 's,:,: makefile,'>$@
boolector: boolectormain.o libboolector.a
	$(CC) $(CFLAGS) -o $@ boolectormain.o -L. -lboolector $(LIBS)@STRIP@
merged.c: btorconfig.h $(SRC) makefile contrib/merge
	rm -f merged.c; ./contrib/merge > merged.c
merged.o: merged.c
	$(CC) $(CFLAGS) -c merged.c
	strip --strip-unneeded $@
merge: boolectormain.o merged.o
	rm -f libboolector.a
	ar rc libboolector.a merged.o $(PICOSATOBJ)
	strip --strip-unneeded libboolector.a
	$(CC) $(CFLAGS) -o boolector boolectormain.o -L. -lboolector $(LIBS)@STRIP@
	@make -s size symbols
seperate:
	rm -f libboolector.a
	make all
	@make -s size symbols
size:
	@ls -l libboolector.a boolector|awk '{print $$NF,$$5,"bytes"}'
symbols:
	@symbols=`nm libboolector.a|wc -l`; \
	echo "libboolector.a $$symbols symbols"

test: $(TESTOBJ) libboolector.a 
	$(CC) $(CFLAGS) -o $@ $(TESTOBJ) -L. -lboolector $(LIBS)@STRIP@

synthebtor: synthebtor.o libboolector.a
	$(CC) $(CFLAGS) -o $@ synthebtor.o -L. -lboolector $(LIBS)@STRIP@

deltabtor: deltabtor.c makefile
	$(CC) $(CFLAGS) -o $@ deltabtor.c@STRIP@

basicbtor: basicbtor.c makefile
	$(CC) $(CFLAGS) -o $@ basicbtor.c@STRIP@

libboolector.a: $(LIBOBJ)
	rm -f $@
	ar rc $@ $(LIBOBJ)
	ranlib $@

btorconfig.h: makefile VERSION mkconfig
	rm -f $@; ./mkconfig > $@

clean:
	rm -f test boolector deltabtor synthebtor basicbtor
	rm -f *.o *.a
	rm -f *.gcda *.gcno *.gcov 
	rm -f log/*.log
	rm -f dependencies
	rm -f *.tmp
	rm -f makefile
	rm -f btorconfig.h
	rm -f merged.c

.PHONY: all clean merge seperate size symbols
