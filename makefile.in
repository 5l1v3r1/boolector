.SUFFIXES: .o .c .cc

MAKEFLAGS=-j $(if $(CORES),$(CORES),1)
CC=@CC@
CXX=@CXX@
BINDIR=@BINDIR@
BUILDIR=@BUILDIR@
TESTDIR=@TESTDIR@
SRCDIR=@SRCDIR@
SRCDIRS=@SRCDIRS@
INCS=@INCS@
CFLAGS=@CFLAGS@
OBJS=@OBJS@
LIBS=@LIBS@
LDEPS=@LDEPS@
VERSION=$(shell cat VERSION)
LIBOBJS=$(filter-out $(BUILDIR)/btormain.o $(BUILDIR)/btormbt.o $(BUILDIR)/btoruntrace.o, $(subst $(SRCDIR), $(BUILDIR), $(patsubst %.c,%.o,$(foreach d,$(SRCDIRS),$(wildcard $(d)/btor[a-z]*.c)))))
LIBOBJS+=$(BUILDIR)/boolector.o $(BUILDIR)/utils/boolectormap.o $(OBJS)
LIBOBJS+=$(BUILDIR)/aigprop.o
SRCS=$(foreach d,$(SRCDIRS),$(wildcard $(d)/*.[c|h|cc]))
TARGETS=@TARGETS@
ROOT=@ROOT@

all: updateconfig $(BUILDIR)/libboolector.a $(TARGETS)

updateconfig: makefile VERSION mkconfig.sh
	@mkdir -p $(BUILDIR)
	@./mkconfig.sh $(BUILDIR)/btorconfig.h

-include $(BUILDIR)/dependencies
-include test.mk
-include ibv.mk
-include mbt.mk
-include python.mk

$(BUILDIR)/%.o: $(SRCDIR)/%.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -c $< -o $@

$(BUILDIR)/%.o: $(SRCDIR)/%.cc
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -c $< -o $@

$(BUILDIR)/dependencies: $(BUILDIR)/btorconfig.h $(SRCS) makefile
	rm -f $@
	for srcdir in $(SRCDIRS); \
	do \
	  find $$srcdir/ -maxdepth 1 -name "*.[ch]" -o -name \*.cc | \
	  xargs $(CC) $(CFLAGS) $(INCS) -MM | \
	  sed -e 's,\(.*\):,'$(BUILDIR)/$$srcdir/'\1: makefile,' | \
		sed -e 's,$(SRCDIR)/\(.*\.o\),\1,' >>$@; \
	done

analyze:
	clang --analyze $(CFLAGS) $(INCS) \
	  $(shell find $(SRCDIRS) -maxdepth 1 -name "*.[ch]" -o -name "*.cc")

$(BUILDIR)/libboolector.a: $(LIBOBJS)
	rm -f $@
	ar rc $@ $(LIBOBJS)
	ranlib $@

SHOBJS=$(filter-out $(BUILDIR)/btormbt.o $(BUILDIR)/btoruntrace.o $(BUILDIR)/btormain.o $(BUILDIR)/boolectormain.o, $(LIBOBJS))
$(BUILDIR)/libboolector.so: $(SHOBJS)
	$(CC) $(CFLAGS) -shared -o $@ $(SHOBJS) $(LIBS) -Xlinker -soname=libboolector.so

$(BINDIR)/boolector: $(BUILDIR)/btormain.o $(BUILDIR)/boolectormain.o $(LDEPS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -o $@ $(BUILDIR)/btormain.o $(BUILDIR)/boolectormain.o $(LDEPS) $(LIBS) -lboolector

clean:
	rm -f makefile
	rm -f $(SRCDIR)/$(TESTDIR)/log/*.log
	rm -f -r $(BINDIR)
	rm -f -r $(BUILDIR)

.PHONY: all analyze clean updateconfig
