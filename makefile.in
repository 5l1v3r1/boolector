.SUFFIXES: .o .c .cc

MAKEFLAGS=-j $(if $(CORES),$(CORES),1)
CC=@CC@
CXX=@CXX@
BUILDIR=@BUILDIR@
TESTDIR=@TESTDIR@
SRCDIRS=@SRCDIRS@
INCS=-I. -I $(BUILDIR) @INCS@
CFLAGS=@CFLAGS@
OBJS=@OBJS@
LIBS=@LIBS@
LDEPS=@LDEPS@
VERSION=$(shell cat VERSION)
SRC=$(foreach d,$(SRCDIRS),$(wildcard $(d)/*.[c|h|cc]))
SRC+=$(foreach d,$(SRCDIRS),$(wildcard $(d)/boolector*.[c|h|cc]))
LIBOBJ=$(patsubst %.c,$(BUILDIR)/%.o,$(filter %.c, $(SRC))) $(OBJS)
TARGETS=@TARGETS@
ROOT=$(shell pwd|sed -e 's, ,\\ ,g')

all: $(BUILDIR)/libboolector.a $(TARGETS)

-include $(BUILDIR)/dependencies
-include test.mk
-include ibv.mk
-include mbt.mk
-include python.mk

$(BUILDIR)/%.o: %.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -c $< -o $@

$(BUILDIR)/%.o: %.cc
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -c $< -o $@

$(BUILDIR)/analyze:
	@mkdir -p $(@D)
	clang --analyze $(CFLAGS) $(INCS) \
	  $(shell find $(SRCDIRS) -maxdepth 1 -name "*.[ch]" -o -name "*.cc")

$(BUILDIR)/dependencies: $(BUILDIR)/btorconfig.h $(SRC) makefile
	@mkdir -p $(@D)
	rm -f $@
	for srcdir in $(SRCDIRS); \
	do \
	  find $$srcdir/ -maxdepth 1 -name "*.[ch]" -o -name \*.cc | \
	  xargs $(CC) $(CFLAGS) $(INCS) -MM | \
	  sed -e 's,\(.*\):,'$(BUILDIR)/$$srcdir/'\1: makefile,' >>$@; \
	done

$(BUILDIR)/boolector: $(BUILDIR)/boolectormain.o $(BUILDIR)/libboolector.a $(LDEPS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) $(INCS) -o $@ $(BUILDIR)/boolectormain.o -L$(BUILDIR) -lboolector $(LIBS) $(LDEPS)

$(BUILDIR)/libboolector.a: $(LIBOBJ)
	@mkdir -p $(@D)
	rm -f $@
	ar rc $@ $(LIBOBJ)
	ranlib $@

$(BUILDIR)/btorconfig.h: makefile VERSION mkconfig
	@mkdir -p $(@D)
	rm -f $@; ./mkconfig > $@

SONAME=-Xlinker -soname -Xlinker $(BUILDIR)/libboolector.so
SHOBJS=$(filter-out ./$(BUILDIR)/btormbt.o ./$(BUILDIR)/btoruntrace.o ./$(BUILDIR)/btormain, $(LIBOBJ))
$(BUILDIR)/libboolector.so: $(SHOBJS)
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -shared -o $@ $(SHOBJS) $(LIBS) $(SONAME)

clean:
	rm -f $(TARGETS)
	rm -f makefile
	rm -f $(foreach d,$(SRCDIRS),$(d)/*.{gcda,gcno,gcov,plist})
	rm -f log/*.log *.tmp
	rm -f *.a *.so $(foreach d,$(SRCDIRS),$(d)/*.o)# TODO remove
	rm -f -r $(BUILDIR)


.PHONY: all analyze clean
