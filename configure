#!/bin/sh

debug=unknown
precosat=unknown
lingeling=unknown
forcearch=no

die () {
  echo "*** configure: $*" 1>&2
  exit 1
}

usage () {
cat <<EOF
usage: ./configure [<option> ...]

where <option> is one of the following:

  -O              optimized compilation (default)
  -g              compile with debugging support
  -m{32,64}       force 32-bit or 64-bit compilation

By default all supported SAT solvers are used and linked into
the binary if they can be found in the parent directory.

  --precosat      use and link with PrecoSAT
  --lingeling     use and link with Lingeling

To disable some of them use the following options:

  --no-precosat   do not use PrecoSAT
  --no-lingeling  do not use Lingeling

In addition PicoSAT is always required as default back end SAT solver.
EOF
  exit 0
}

while [ $# -gt 0 ]
do
  case $1 in
    -g) debug=yes;;
    -O) debug=no;;
    -m32|--m32) forcearch=32;;
    -m64|--m64) forcearch=64;;
    --precosat) precosat=yes;;
    --lingeling) lingeling=yes;;
    --no-precosat) precosat=no;;
    --no-lingeling) lingeling=no;;
    -h|--help) usage;;
    -*) die "invalid option '$1' (try '-h')";;
  esac
  shift
done

if [ X"$CFLAGS" = X ]
then
  [ $debug = unknown ] && debug=no
  CFLAGS="$CFLAGS -W -Wall -Wextra"
  [ $forcearch = 32 ] && CFLAGS="$CFLAGS -m32"
  [ $forcearch = 64 ] && CFLAGS="$CFLAGS -m64"
  if [ $debug = yes ]
  then
    CFLAGS="$CFLAGS -g3 -ggdb"
  else
    CFLAGS="$CFLAGS -DNDEBUG -O3"
  fi
elif [ $debug = yes ]
then
  die "CFLAGS environment variable defined and '-g' used"
elif [ $debug = no ]
then
  die "CFLAGS environment variable defined and '-O' used"
fi

LIBS=""
OBJS=""

if [ $precosat = yes ]
then
  [ X"$CFLAGS" = X ] || CFLAGS="$CFLAGS "
  [ X"$OBJS" = X ] || OBJS="$OBJS "
  [ X"$LIBS" = X ] || LIBS="$LIBS "
  CFLAGS="${CFLAGS}-DBTOR_USE_PRECOSAT"
  OBJS="${OBJS}btorpreco.o ../precosat/precosat.o ../precosat/precobnr.o"
  LIBS="${LIBS}-lz"
  if [ X"`echo "$LIBS" | grep 'lstdc++'`" = X ]
  then
    [ X"$LIBS" = X ] || LIBS="$LIBS "
    LIBS="${LIBS}-lstdc++"
  fi
fi

if [ $lingeling = yes ]
then
  [ X"$CFLAGS" = X ] || CFLAGS="$CFLAGS "
  [ X"$LDEPS" = X ] || LDEPS="$LDEPS "
  [ X"$LIBS" = X ] || LIBS="$LIBS "
  CFLAGS="${CFLAGS}-DBTOR_USE_LINGELING"
  LIBS="${LIBS}-L../lingeling -llgl -lm"
  LDEPS="${LDEPS}../lingeling/liblgl.a"
fi

[ "X$CC" = X ] && CC=gcc

echo "[configure] debug ... $debug"
echo "[configure] CC ... $CC"
echo "[configure] CFLAGS ... $CFLAGS"
echo "[configure] LIBS ... $LIBS"
echo "[configure] OBJS ... $OBJS"

echo -n "[configure] makefile ..."
rm -f makefile
sed \
  -e "s,@CC@,$CC," \
  -e "s,@CFLAGS@,$CFLAGS," \
  -e "s,@LIBS@,$LIBS," \
  -e "s,@LDEPS@,$LDEPS," \
  -e "s,@OBJS@,$OBJS," \
  makefile.in > makefile
echo " done"
