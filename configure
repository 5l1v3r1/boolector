#!/bin/sh

LIBS=""

debug=no

o1=no
o2=yes
o3=no
static=no
m32=no
m64=no
gpt=no
release=no
competition=no
picoprep=no
precosat=no
strip=no
cov=no

while [ $# -gt 0 ]
do
  case $1 in
    -g) debug=yes; cov=no; o1=no; o2=no; o3=no;;
    -cov) debug=no; cov=yes; o1=no; o2=no; o3=no;;
    -O1) debug=no; cov=no; o1=yes; o2=no; o3=no;;
    -O2) debug=no; cov=no; o1=no; o2=yes; o3=no;;
    -O3) debug=no; cov=no; o1=no; o2=no; o3=yes;;
    -no-opt) o1=no; o2=no; o3=no;;
    -static) static=yes;;
    -m32) m32=yes;;
    -m64) m64=yes;;
    -s) strip=yes;;
    -gpt) gpt=yes; debug=no; cov=no; o1=no; o2=yes; o3=no;;
    -picoprep) picoprep=yes;precosat=no;;
    -precosat) picoprep=no;precosat=yes;;
    -r) competition=no; release=yes; precosat=yes; picoprep=no; static=no; debug=no; cov=no; o1=no; o2=no; o3=yes; strip=yes;;
    -c) competition=yes; release=no; precosat=yes; picoprep=no; static=yes; debug=no; cov=no; o1=no; o2=no; o3=yes; strip=yes;;
    *) cat <<EOF
*** usage: ./configure [-g][-s][-cov][-O[1-3]][-no-opt][-static][-m{32,64}][-gpt][-picoprep][-precosat][-r][-c]
EOF
exit 1
;;
  esac
shift
done

[ $precosat = yes -a $picoprep = yes ] && \
  die "can not use both '-precosat' and '-picoprep'"

if [ X"$CFLAGS" = X ]; then
  CFLAGS="$CFLAGS -W -Wall -Wextra"
  [ $static = yes ] && CFLAGS="$CFLAGS -static"
  [ $m32 = yes ] && CFLAGS="$CFLAGS -m32"
  [ $m64 = yes ] && CFLAGS="$CFLAGS -m64"
  if [ $debug = yes ]; then
    CFLAGS="$CFLAGS -g3 -ggdb"
  else
    CFLAGS="$CFLAGS -DNDEBUG"
    if [ $cov = yes ]; then
      CFLAGS="$CFLAGS -fprofile-arcs -ftest-coverage"
    elif [ $o3 = yes ]; then
      CFLAGS="$CFLAGS -O3 -fomit-frame-pointer"
    elif [ $o2 = yes ]; then
      CFLAGS="$CFLAGS -O2"
    elif [ $o1 = yes ]; then
      CFLAGS="$CFLAGS -O1"
    fi
  fi
fi

if [ $competition = yes  -o $release = yes -a $gpt = yes ]; then
  LIBS=$LIBS" -ltcmalloc -lstdc++ -lpthread"
elif [ $gpt = yes ]; then
  LIBS=$LIBS" -ltcmalloc -lprofiler"
fi

PICOPREP_OBJS=""
if [ $picoprep = yes ]; then
  CFLAGS=$CFLAGS" -DBTOR_USE_PICOPREP"
  PICOPREP_OBJS="../picoprep/libpicoprep.o ../picoprep/version.o"
  LIBS=$LIBS" -lz"
fi

PRECOSAT_OBJS=""
if [ $precosat = yes ]; then
  CFLAGS=$CFLAGS" -DBTOR_USE_PRECOSAT"
  PRECOSAT_OBJS="btorpreco.o ../precosat/precosat.o ../precosat/precobnr.o"
  LIBS=$LIBS" -lz"
  if [ x"`echo "$LIBS" | grep 'lstdc++'`" = x ]; then
    LIBS=$LIBS" -lstdc++"
  fi
fi

if [ $strip = yes ]
then
  STRIP='; strip $@'
else
  STRIP=""
fi

[ "X$CC" = X ] && CC=gcc

echo "cc ... $CC"
echo "cflags ... $CFLAGS"
echo "libs ... $LIBS"
echo "debug ... $debug"
echo "coverage ... $cov"
echo "O1 ... $o1"
echo "O2 ... $o2"
echo "O3 ... $o3"
echo "static ... $static"
echo "m32 ... $m32"
echo "m64 ... $m64"
echo "gpt ... $gpt"
echo "picoprep ... $picoprep"
echo "precosat ... $precosat"
echo "strip ... $strip"


echo -n "makefile ..."
rm -f makefile
sed \
  -e "s,@CC@,$CC," \
  -e "s,@CFLAGS@,$CFLAGS," \
  -e "s,@LIBS@,$LIBS," \
  -e "s,@STRIP@,$STRIP," \
  -e "s,@PICOPREP_OBJS@,$PICOPREP_OBJS," \
  -e "s,@PRECOSAT_OBJS@,$PRECOSAT_OBJS," \
  makefile.in > makefile
echo " done"
